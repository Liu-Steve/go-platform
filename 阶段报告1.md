# 阶段报告 1

## 一、本轮迭代完成的工作

### Server 部分

#### 系统模块

1、实现统一异常处理功能
当系统中出现异常时，后端可以进行捕获和处理，返回给前端合适的信息
2、实现统一鉴权功能
当用户登录成功时，后端会向前端返回对应的Token，当前端后续调用其他接口时，后端会在过滤器中对Token进行校验，保证接口的调用权限
3、数据库结构定义和表创建
go_user：用户表，记录用户信息
go_role：用户角色表
go_user_roles：用户与角色映射关系
go_game_log：游戏记录表
4、实现数据库交互功能
使用Spring Data JPA实现数据库的交互

#### 用户模块

##### 注册功能

用户在前端输入注册内容后，后端首先根据提前定义好的正则表达式校验用户输入的格式是否正确，然后校验用户名和邮箱是否重复，如果校验全都成功后，则将数据入库，并通知前端创建成果，并把用户数据返回给前端。
1、实现前端用户注册数据的校验
2、如果注册数据无误，则根据注册信息创建用户实体对象
3、使用bcrypt对用户密码进行加密
4、将用户实体对象入库
5、将注册的用户信息返回给前端

##### 登录功能

前端获取用户的输入后通过接口发送给后端，后端首先校验用户的用户名密码是否正确，如果用户信息正确则将生成Token发送给前端，以便前端调用后续接口，并且后端将返回给前端用户具体信息，前端可以根据用户Id进行后续调用。
1、根据前端数据进行用户校验、判断用户名密码是否正确
2、后端生成Token
3、将Token和用户信息发送给前端

##### 查询用户功能

用户根据用户id来查看用户信息，在调用此接口时需要附加Token信息。
1、前端传入用户Id和Token
2、后端校验Token是否有效
3、根据Id来查找用户数据
4、将用户数据返回给前端

##### 房间模块

后端接收前端传来的用户创建房间、用户进入房间、用户退出房间的命令，对房间信息进行维护：
1.创建房间：生成特定房间ID，并绑定好创建者的ID和创建时间，初始化房间人数为１人。
2.进入房间：将用户ID绑定在房间第二人信息中。当前默认加入房间就是加入棋局。
3.退出房间：只剩1人时退出房间将销毁房间；剩2人时退出房间，将退出用户的信息记录置为空，并将留下的用户绑定到房主信息。当前默认退出房间就是退出棋局。

房间和棋盘是一对一的关系；房间可以通过房间ID被查找，棋盘被内置在房间实例对象中进行维护。

##### 棋盘模块

后端接收前端传来的用户选定棋盘设置并创建棋盘、进入/退出棋盘、房主用户换边的请求，修改棋盘的信息：
1、创建棋盘：读取传来的棋盘config信息，配置好棋盘状态到：游戏中状态、黑放落子。并将棋盘和配置绑定到对应房间信息中，
2、进入棋盘：把用户的id绑定到棋盘剩余的棋手信息中。
3、退出棋盘：把用户id对应的棋手信息置为null。
4、房主更换颜色（换边）：把房主的id绑定到指定颜色的棋手信息上，并将被覆盖的棋手信息交换到房主原边棋手的信息上。
5、前端于棋盘上落子，会向后端发出请求，后端接收前端传来的请求定位到正在进行的对局，判断该落子是否合法，包括自身不能无气、提子等规则，并修改当前状态；暂未完成禁止全局同型、打劫判断的规则。

### UI 部分

#### 界面部分

* 主界面
    * 完成界面样式的编写
    * 完成页面间跳转切换
    * 完成登录/注册页面的编写
    * 完成注册时基本的信息校验功能

* 用户个人界面
    * 暂未完成
    * 仅提供基本的跳转功能
    
* 围棋下棋界面
    * 完成棋盘基本功能的编写
    * 完成界面的基本布局，根据窗口大小改变自适应棋盘

### 部署及其他部分

1、购置了服务器与域名，完成了域名备案
2、为服务器配置了 Nginx，配置了 SSL 证书以实现 HTTPS
3、为后端运行的主机配置了 FRP 反向代理，实现端口映射
4、为主机安装了 docker，并部署了 docker 版的 MySQL 8
5、配置了后端镜像打包 Maven 插件
6、编写了容器更新脚本与前端打包拷贝脚本

## 二、下轮迭代的目标

### Server 部分

#### 用户模块

1、新增修改用户信息功能，用户可以修改自己的用户名，或者修改自己的密码

#### 房间模块

1、用户鉴权
2、除对局模式外，添加对局分析与研究模式，并考虑将棋局研究接入AI

#### 棋盘模块

1、新增落子记录功能，记录每个选手的落子位置顺序以及位置
2、打劫功能
3、棋局结束功能：棋局无法继续下棋、用户请求结束对局和确认结束对局；保存棋谱；重新开始一局游戏
4、增加 WebSocket 通信功能，用于通知对手落子

### UI 部分

1、完善棋盘界面，增加更多对局信息展示
2、完善用户信息界面，提供更改密码等服务
3、完善与后端之间的通信，增加 WebSocket 支持

### 部署及其他部分

1、继续优化打包流程
2、完成 KataGo 的部署
